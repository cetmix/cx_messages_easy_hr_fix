<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Style can be applied directly in report -->
    <style>
        table, td {
        border: 1px solid black;
        border-collapse:collapse;
        height: 30px;
        }
        tr {
        vertical-align:middle;
        }
    </style>

    <!-- Inherited report -->
    <template id="cetmix_report_sale" inherit_id="sale.report_saleorder_document">
        <xpath expr="//div[@t-field='doc.partner_id']" position="before">
            <strong>Customer:</strong>
        </xpath>
        <xpath expr="//t[@t-set='information_block']" position="replace">
            <t t-set="information_block">
                <t t-if="doc.partner_shipping_id != doc.partner_id">
                    <strong>Shipping address:</strong>
                    <div t-field="doc.partner_shipping_id"
                         t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}'/>
                </t>
            </t>
        </xpath>
        <xpath expr="//div[@name='total']/div" position="attributes">
            <attribute name="t-attf-class">col-4 ml-auto</attribute>
            <attribute name="style">padding-left:30px;</attribute>
        </xpath>
        <xpath expr="//span[@t-field='doc.amount_untaxed']//.." position="after">
            <td t-if="doc.other_currency" class="text-right" style="margin-left:20px;">
                <span t-field="doc.other_untaxed"/>
            </td>
        </xpath>
        <xpath expr="//span[@t-field='doc.amount_total']//.." position="after">
            <td t-if="doc.other_currency" class="text-right" style="margin-left:20px;">
                <span t-field="doc.other_total"/>
            </td>
        </xpath>
        <xpath expr="//t[@t-as='amount_by_group']/tr" position="inside">
            <td t-if="doc.other_currency" class="text-right" style="margin-left:20px;">
                <span t-field="doc.other_tax"/>
            </td>
        </xpath>
        <xpath expr="//div[@class='page']/div[@class='oe_structure'][2]" position="before">
            <div t-if="doc.other_currency">*Just for VAT purposes</div>
        </xpath>
        <xpath expr="//div[@class='page']/div[@class='oe_structure'][2]" position="before">
            <div t-if="doc.other_currency" t-attf-style="{{'color:red' if line.scrapped else ''}}">*Just for VAT purposes</div>
        </xpath>

    </template>

    <template id="report_saleorder_delivery_note_document">
        <t t-call="web.external_layout">
            <t t-set="doc" t-value="doc.with_context({'lang':doc.partner_id.lang})" />
            <t t-set="address">
                <strong>Customer:</strong>
                <div t-field="doc.partner_id"
                     t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}' />
                <p t-if="doc.partner_id.vat"><t t-esc="doc.company_id.country_id.vat_label or 'Tax ID'"/>: <span t-field="doc.partner_id.vat"/></p>
            </t>

            <t t-if="doc.partner_shipping_id == doc.partner_invoice_id
                                 and doc.partner_invoice_id != doc.partner_id
                                 or doc.partner_shipping_id != doc.partner_invoice_id">
                <t t-set="information_block">
                    <t t-if="doc.partner_shipping_id != doc.partner_id">
                        <strong>Shipping address:</strong>
                        <div t-field="doc.partner_shipping_id"
                             t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}'/>
                    </t>
                </t>
            </t>

            <div class="page">
                <div class="oe_structure"/>

                <h2><span t-if="doc.state not in ['draft','sent']">Order # </span>
                    <span t-field="doc.name"/>
                </h2>

                <!-- This is how we can split datetime into date and time format and display them separately -->
                <div t-if="doc.date_planned_from" class="row">
                    <div class="col-3">From Date:</div>
                    <div class="col-9">
                        <!-- This will use sever TZ -->
                        <div t-esc="doc.date_planned_from.date().strftime('%d.%m.%Y')"/>
                        <!-- This will use user's TZ -->
                        <div t-esc="context_timestamp(doc.date_planned_from).date().strftime('%d.%m.%Y')"/>
                    </div>
                </div>
                <div t-if="doc.date_planned_from" class="row">
                    <div class="col-3">From Time:</div>
                    <div class="col-9">
                        <div t-esc="'{:d}:{:02d}'.format(doc.date_planned_from.hour, doc.date_planned_from.minute)"/>
                    </div>
                </div>

                <!-- Is there a discount on at least one line? -->
                <t t-set="display_discount" t-value="any([l.discount for l in doc.order_line])"/>

                <table class="table table-sm o_main_table">
                    <thead>
                        <tr>
                            <t t-set="colspan" t-value="5"/>
                            <th class="text-left">Description</th>
                            <th class="text-right">Quantity</th>
                        </tr>
                    </thead>
                    <tbody class="sale_tbody">

                        <t t-foreach="doc.order_line" t-as="line">
                            <tr t-att-class="'bg-200 font-weight-bold o_line_section' if line.display_type == 'line_section' else 'font-italic o_line_note' if line.display_type == 'line_note' else ''">
                                <t t-if="not line.display_type">
                                    <td><span t-field="line.name"/></td>
                                    <td class="text-right">
                                        <span t-field="line.product_uom_qty"/>
                                        <span t-field="line.product_uom" groups="uom.group_uom"/>
                                    </td>
                                </t>
                                <t t-if="line.display_type == 'line_section'">
                                    <td t-att-colspan="colspan">
                                        <span t-field="line.name"/>
                                    </td>
                                    <t t-set="current_section" t-value="line"/>
                                    <t t-set="current_subtotal" t-value="0"/>
                                </t>
                                <t t-if="line.display_type == 'line_note'">
                                    <td t-att-colspan="colspan">
                                        <span t-field="line.name"/>
                                    </td>
                                </t>
                            </tr>
                        </t>
                    </tbody>
                </table>

                <div t-if="doc.signature" class="mt32 ml16 mr16" name="signature">
                    <div class="offset-8">
                        <strong>Signature</strong>
                    </div>
                    <div class="offset-8">
                        <img t-att-src="image_data_uri(doc.signature)" style="max-height: 4cm; max-width: 8cm;"/>
                    </div>
                    <div class="offset-8 text-center">
                        <p t-field="doc.signed_by"/>
                    </div>
                </div>

                <div class="oe_structure"/>
            </div>
        </t>
    </template>
    <template id="report_saleorder_delivery_note">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="cetmix_custom_module.report_saleorder_delivery_note_document" t-lang="doc.partner_id.lang"/>
            </t>
        </t>
    </template>

    <data>
        <report
                id="action_report_saleorder_delivery_note"
                string="Delivery note"
                model="sale.order"
                report_type="qweb-pdf"
                file="cetmix_custom_module.report_saleorder_delivery_note"
                name="cetmix_custom_module.report_saleorder_delivery_note"
                print_report_name="'Delivery note - %s' % (object.name)"
        />
    </data>

</odoo>